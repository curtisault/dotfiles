#!/usr/bin/env bash
# Install dependencies documented in linux/README.md on CachyOS (Arch-based)

set -euo pipefail

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

log_info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

log_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

log_warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

check_pacman() {
    if ! command -v pacman &> /dev/null; then
        log_error "pacman not found. This script is designed for CachyOS/Arch."
        exit 1
    fi
}

pacman_install() {
    local pkg="$1"
    if ! pacman -Qi "$pkg" &> /dev/null 2>&1; then
        log_info "Installing $pkg via pacman..."
        sudo pacman -S --needed --noconfirm "$pkg"
    else
        log_info "$pkg already installed"
    fi
}

# ============================================================================
# Dotfile Management
# ============================================================================

setup_stow() {
    log_info "Setting up stow..."
    pacman_install stow
    log_success "stow installed"
}

# ============================================================================
# Shell & Terminal
# ============================================================================

setup_fish() {
    log_info "Setting up fish..."
    pacman_install fish

    if [ "$SHELL" != "$(which fish)" ]; then
        log_warn "Fish is not your default shell. Run: chsh -s \$(which fish)"
    else
        log_info "Fish is already the default shell"
    fi

    log_success "fish installed"
}

setup_ghostty() {
    log_info "Setting up ghostty..."
    pacman_install ghostty
    log_success "ghostty installed"
}

setup_starship() {
    log_info "Setting up starship..."
    pacman_install starship
    log_success "starship installed"
}

setup_atuin() {
    log_info "Setting up atuin..."
    pacman_install atuin
    log_success "atuin installed"
}

setup_tmux() {
    log_info "Setting up tmux..."
    pacman_install tmux
    log_success "tmux installed"
}

# ============================================================================
# Dev Tools
# ============================================================================

setup_neovim() {
    log_info "Setting up neovim..."
    pacman_install neovim
    log_success "neovim installed"
}

setup_mise() {
    log_info "Setting up mise..."
    pacman_install mise
    log_success "mise installed"
}

setup_lazygit() {
    log_info "Setting up lazygit..."
    pacman_install lazygit
    log_success "lazygit installed"
}

setup_github_cli() {
    log_info "Setting up GitHub CLI..."
    pacman_install github-cli
    log_success "GitHub CLI installed"
}

# ============================================================================
# CLI Tools
# ============================================================================

setup_ripgrep() {
    log_info "Setting up ripgrep..."
    pacman_install ripgrep
    log_success "ripgrep installed"
}

setup_duf() {
    log_info "Setting up duf..."
    pacman_install duf
    log_success "duf installed"
}

setup_ncdu() {
    log_info "Setting up ncdu..."
    pacman_install ncdu
    log_success "ncdu installed"
}

setup_yazi() {
    log_info "Setting up yazi..."
    pacman_install yazi
    log_success "yazi installed"
}

setup_bottom() {
    log_info "Setting up bottom..."
    pacman_install bottom
    log_success "bottom installed"
}

# ============================================================================
# System
# ============================================================================

setup_keyd() {
    log_info "Setting up keyd..."

    pacman_install keyd

    local conf="/etc/keyd/default.conf"
    if [ ! -f "$conf" ]; then
        log_info "Writing keyd config to $conf..."
        sudo mkdir -p /etc/keyd
        sudo tee "$conf" > /dev/null << 'EOF'
[ids]
*

[main]
capslock = overload(control, esc)
EOF
        log_success "keyd config written"
    else
        log_info "keyd config already exists at $conf, skipping"
    fi

    sudo systemctl enable --now keyd
    sudo keyd reload
    log_success "keyd installed and enabled"
}

setup_pass() {
    log_info "Setting up pass..."

    pacman_install pass

    if pass ls &> /dev/null; then
        log_info "Password store already initialized"
    else
        log_warn "Password store not initialized. Run: pass init <gpg-id>"
        log_info "If you need a GPG key: gpg --full-generate-key"
    fi

    log_success "pass installed"
}

# ============================================================================
# Main
# ============================================================================

main() {
    check_pacman

    log_info "Starting CachyOS setup..."
    echo

    local failed=0

    # Dotfile Management
    setup_stow || ((failed++))
    echo

    # Shell & Terminal
    setup_fish || ((failed++))
    setup_ghostty || ((failed++))
    setup_starship || ((failed++))
    setup_atuin || ((failed++))
    setup_tmux || ((failed++))
    echo

    # Dev Tools
    setup_neovim || ((failed++))
    setup_mise || ((failed++))
    setup_lazygit || ((failed++))
    setup_github_cli || ((failed++))
    echo

    # CLI Tools
    setup_ripgrep || ((failed++))
    setup_duf || ((failed++))
    setup_ncdu || ((failed++))
    setup_yazi || ((failed++))
    setup_bottom || ((failed++))
    echo

    # System
    setup_keyd || ((failed++))
    echo
    setup_pass || ((failed++))
    echo

    # Summary
    if [ $failed -eq 0 ]; then
        log_success "Setup completed successfully!"
    else
        log_warn "$failed component(s) failed to set up"
    fi

    echo
    log_info "Done!"
}

main "$@"
